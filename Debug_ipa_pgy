#!/bin/bash

# è®¡æ—¶
SECONDS=0
# è·å–å·¥ç¨‹æ ¹ç›®å½•
fadir()  
{  
    local this_dir=`pwd`  
    local child_dir="$1" 
    dirname "$child_dir" 
    cd $this_dir  
} 
CUR_DIR=$(cd `dirname $0` && pwd -P )
PROJ_BIN=`fadir $CUR_DIR`
echo "å½“å‰æ–‡ä»¶è·¯å¾„ $CUR_DIR"
echo "å½“å‰æ–‡ä»¶è·¯å¾„ä¸Šä¸€çº§ $PROJ_BIN"




echo "

ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  å¼€å§‹æ‰“åŒ…! ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰ 

"
#å·¥ç¨‹ç»å¯¹è·¯å¾„
cd $PROJ_BIN
project_path=$(pwd)
echo "å·¥ç¨‹è·¯å¾„ $project_path"
# è¾“å‡ºåˆ°æ¡Œé¢
output_path=~/Desktop
#è·å–å·¥ç¨‹é»˜è®¤schemeçš„åå­—ï¼ˆé»˜è®¤ä¸å·¥ç¨‹æ–‡ä»¶åå­—ç›¸åŒï¼‰
scheme_name=$(echo $(basename ./*.xcodeproj) | awk -F. '{print $1}')
echo "è¾“å‡ºscheme_name $scheme_name"

App_Name=`find . -name *.xcodeproj | awk -F "[/.]" '{print $(NF-1)}'`
echo "è¾“å‡ºApp_Name $App_Name"

# info.plistæ–‡ä»¶è·¯å¾„
InfoPlist_Path="${Project_Path}/${App_Name}/Info.plist"

Workspace_Path="${project_path}/${App_Name}.xcworkspace"
Xcodeproj_Path="${project_path}/${App_Name}.xcodeproj"
# project.pbxprojæ–‡ä»¶è·¯å¾„
Pbxproj_Path="${Xcodeproj_Path}/project.pbxproj"
echo "è¾“å‡ºPbxproj_Path $Pbxproj_Path"

# Pbxproj_PathæŒ‡å‘ project.pbxproj æ–‡ä»¶è·¯å¾„
configuration=$(grep -i "MARKETING_VERSION =" ${Pbxproj_Path})

Array=($(echo $configuration))
# project.pbxproj ä¸­å­˜åœ¨å¤šè¡ŒPRODUCT_BUNDLE_IDENTIFIERä¿¡æ¯ï¼Œä»åå¾€å‰è¯»å–
MARKETING_VERSION=${Array[5]}
if [ ! -n $MARKETING_VERSION ]
then
    MARKETING_VERSION=${Array[3]}
fi

# Pbxproj_PathæŒ‡å‘ project.pbxproj æ–‡ä»¶è·¯å¾„
configuration=$(grep -i "PRODUCT_BUNDLE_IDENTIFIER =" ${Pbxproj_Path})
Array=($(echo $configuration))
# echo "ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹$configuration"
# project.pbxproj ä¸­å­˜åœ¨å¤šè¡ŒPRODUCT_BUNDLE_IDENTIFIERä¿¡æ¯ï¼Œä»åå¾€å‰è¯»å–
Bundle_Identifier=${Array[2]}
if [ ! -n $Bundle_Identifier ]
then
    Bundle_Identifier=${Array[13]}
fi
echo "Bundle_Identifier = ${Bundle_Identifier}"

# è·å–æ—¶é—´ å¦‚:201706011145
current_date="$(date +%Y%m%d_%H%M%S)"
# æŒ‡å®šè¾“å‡ºipaè·¯å¾„
export_path="${output_path}/${scheme_name}_${current_date}"
export_path_ipa="${export_path}/${scheme_name}.ipa" 
echo "è¾“å‡ºè·¯å¾„ $export_path_ipa"


fastlane gym --export_method ad-hoc --clean --configuration Debug --output_directory ${export_path} --export_xcargs -allowProvisioningUpdates

if [ $? -eq 0 ]; then
echo "æ‰“åŒ…æ€»ç”¨æ—¶: ${SECONDS}s ~~~~~~~~~~~~~~~~"
echo "

	ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ${scheme_name} æ‰“åŒ…å®Œæˆ! ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  

"
else
    echo "ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰${scheme_name} æ‰“åŒ…å¤±è´¥!ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰"
    exit
fi



if [ "$export_path" != "" ];then
echo "

ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  å¼€å§‹ä¸Šä¼ ! ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰

"
else
    echo "ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰è¾“å‡ºè·¯å¾„å¼‚å¸¸!ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰"
    exit
fi


curl -F "file=@$export_path_ipa" \
-F "_api_key=fcxxxxxxxxxxxxxxxxxxxxxxxxxxdf" https://www.pgyer.com/apiv2/app/upload


  # fir login 96f234022c34f9a96a0d3c60be33388d

  # fir publish $export_path_ipa 


if [ $? -eq 0 ]; then
echo "å…±è®¡æ€»ç”¨æ—¶: ${SECONDS}s ~~~~~~~~~~~~~~~~"
echo "

ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ä¸Šä¼ å®Œæˆ! ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰ 

"
else
    echo "ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰ä¸Šä¼ å¤±è´¥!ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰"
    exit
fi



echo "

ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  å‡†å¤‡å‘é€æ¶ˆæ¯! ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰ 

"

curl -o token.txt \
-s https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=xxxxxxxxxxxxxxx\&corpsecret=xxxxxxxxxxxxxxxxxxx

token=$(cat token.txt |jq -r '.access_token')
echo "è¿™é‡Œæ˜¯ä¸€ä¸ªæ–‡ä»¶çš„å†…å®¹ $token"



current_data="$(date +%Y-%m-%d_%H:%M:%S)"
pgyerQR="https://i.loli.net/2019/09/12/xxxxxxxxxxxxxxxxxxxx.png"

curl -H "Content-Type: application/json" \
-X POST \
-d '{"toparty":"54|3|38|41|45|47|48|51|53|55|56|57|58|18|60","msgtype":"news","agentid":1000003,"news":{"articles":[{"title":"iOSAPP","description" : "Debugæµ‹è¯•åŒ…'$MARKETING_VERSION'ç‰ˆæœ¬å·²äº'${current_data}'æ‰“åŒ…æˆåŠŸ","url":"https://www.pgyer.com/ikang","picurl":"'${pgyerQR}'"}]}}' https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=$token

echo "

ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  å‘é€æ¶ˆæ¯å®Œæˆ! ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰ 

"

exit
 

